<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FishingRPG - Your Fishing Adventure</title>
    <!-- ...Styles unchanged for brevity... -->
    <style>
        /* ...Styles omitted for brevity, unchanged... */
    </style>
</head>
<body>
<div class="container">
    <!-- ...HTML markup unchanged for brevity... -->
    <!-- Everything up to the scripts is unchanged -->
</div>

<!-- MAIN GAME SCRIPT (with timing mini-game) -->
<script>
    // All JS code before leaderboard sync is unchanged
    // ... (unmodified code omitted for brevity) ...
</script>

<!-- FIREBASE + LEADERBOARD + CHAT + DISCORD FRONT-END -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
        getDatabase,
        ref,
        set,
        onValue,
        query,
        orderByChild,
        limitToLast,
        get,
        push
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCnwHvRXlLzC122GIusPgwlboJA2qdRKcE",
        authDomain: "fishingrpg.firebaseapp.com",
        databaseURL: "https://fishingrpg-default-rtdb.firebaseio.com/",
        projectId: "fishingrpg",
        storageBucket: "fishingrpg.appspot.com",
        messagingSenderId: "87406758660",
        appId: "1:87406758660:web:4c540fdcf26f1a5a6dde51",
        measurementId: "G-4BKFFKFQSM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- Read possible Discord callback params ---
    const urlParams   = new URLSearchParams(window.location.search);
    const discordToken = urlParams.get("token");      // Firebase custom token from your backend
    const discordName  = urlParams.get("dname") || urlParams.get("username");

    // --- Username handling ---
    let username = localStorage.getItem('fishingRPG_username');

    if (discordName) {
        const trimmed = discordName.trim();
        if (trimmed) {
            username = trimmed;
            localStorage.setItem('fishingRPG_username', username);
        }
    }

    if (!username) {
        username = prompt("Enter your username for the global leaderboard:") || "";
        username = username.trim();
        if (!username) {
            username = "Player" + Math.floor(Math.random() * 100000);
        }
        if (username.length > 16) username = username.slice(0, 16);
        localStorage.setItem('fishingRPG_username', username);
    }
    window.fishingUsername = username;

    const accountNameEl = document.getElementById("accountName");
    if (accountNameEl) accountNameEl.textContent = username;

    // --- Discord Login button ---
    function loginWithDiscord() {
        const DISCORD_CLIENT_ID = "1441942057051754646";
        const REDIRECT_URI = "https://bry677.github.io/FishingRPG/auth/discord.html";

        const url =
            "https://discord.com/api/oauth2/authorize" +
            "?client_id=" + encodeURIComponent(DISCORD_CLIENT_ID) +
            "&redirect_uri=" + encodeURIComponent(REDIRECT_URI) +
            "&response_type=code" +
            "&scope=identify";

        window.location.href = url;
    }
    window.loginWithDiscord = loginWithDiscord;

    // ---------- Cloud Save ----------
    function syncCloudSave() {
        const gs = window.gameState;
        const user = auth.currentUser;
        if (!user || !gs) return;
        const saveRef = ref(db, "saves/" + user.uid);
        set(saveRef, gs).catch(err => console.error("Error syncing cloud save:", err));
    }
    window.syncCloudSave = syncCloudSave;

    function applyCloudSave(data) {
        if (!data) return;
        const defaults = {
            level: 1,
            xp: 0,
            xpToNext: 100,
            energy: 100,
            maxEnergy: 100,
            gold: 50,
            totalFish: 0,
            inventory: {},
            equipment: {
                rod: { name: 'Basic Rod', catchBonus: 0, energyCost: 10 },
                bait: { name: 'No Bait', catchBonus: 0 }
            },
            ownedEquipment: { rods: [], baits: [] },
            environment: { timeOfDay: 'Day', weather: 'Clear' },
            currentLocationId: 'lake',
            fishStats: {},
            casts: 0
        };
        const gs = Object.assign({}, defaults, data);
        window.gameState = gs;
        if (window.renderEquipment) window.renderEquipment();
        if (window.renderShop) window.renderShop();
        if (window.renderSell) window.renderSell();
        if (window.renderLocations) window.renderLocations();
        if (window.renderEncyclopedia) window.renderEncyclopedia();
        if (window.updateUI) window.updateUI();
        if (window.saveGame) window.saveGame();
    }

    let triedDiscordToken = false;

    // Ensure leaderboard syncs with discordName *after* successful sign in and also after login with custom token.
    function setUsernameFromDiscordIfAvailable() {
        // this runs after firebase login, so auth.currentUser is present
        if (discordName) {
            const trimmed = discordName.trim();
            if (trimmed) {
                username = trimmed;
                localStorage.setItem("fishingRPG_username", username);
                const nameEl = document.getElementById("accountName");
                if (nameEl) nameEl.textContent = username;
                window.fishingUsername = username;
            }
        }
    }

    // Used to force leaderboard sync immediately after Discord login, or as fallback after any login
    function forceLeaderboardSyncAfterUsername(forceImmediate=false) {
        // always use .username at this time, and *inject* username for leaderboard sync
        if (forceImmediate) {
            if (window.syncLeaderboardNow) window.syncLeaderboardNow();
        } else {
            if (window.scheduleLeaderboardSync) window.scheduleLeaderboardSync();
        }
    }

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            // not logged in yet, try discord token
            if (!triedDiscordToken && discordToken) {
                triedDiscordToken = true;
                try {
                    await signInWithCustomToken(auth, discordToken);
                    return;
                } catch (err) {
                    console.error("Discord custom token failed, falling back to anonymous:", err);
                }
            }
            signInAnonymously(auth).catch(err => console.error("Anon auth error:", err));
            return;
        }

        // Now logged in (either via Discord or anon)
        window.fishingUserId = user.uid;

        // If we logged in with Discord, update username and leaderboard immediately
        if (discordName) {
            setUsernameFromDiscordIfAvailable();

            // ðŸ”¥ IMMEDIATE leaderboard sync with correct (discord) username, regardless of local cache
            if (window.syncLeaderboardNow)
                window.syncLeaderboardNow();

            // Return so fallback sync is NOT run
            return;
        }

        // Fallback: force leaderboard sync in 2s (anon user, or normal)
        if (window.scheduleLeaderboardSync)
            window.scheduleLeaderboardSync();

    });

    // ---------- Leaderboard (keyed by UID) ----------
    function syncLeaderboardNow() {
        const gs = window.gameState;
        const user = auth.currentUser;
        // Use ALWAYS UP-TO-DATE username if possible
        let displayName = (typeof window.fishingUsername === "string" ? window.fishingUsername : null) || username || "Player";

        // If a discord name param is present, it should always have priority
        if (discordName && discordName.trim()) displayName = discordName.trim();

        if (!gs || !user) return;

        const biggest = (window.getBiggestCatchKg && window.getBiggestCatchKg()) || 0;
        const userRef = ref(db, "leaderboard/" + user.uid);
        set(userRef, {
            username: displayName,
            level: gs.level || 1,
            totalFish: gs.totalFish || 0,
            gold: gs.gold || 0,
            biggestCatchKg: biggest || 0,
            updatedAt: Date.now()
        }).catch(err => console.error("Error syncing leaderboard:", err));
    }

    let syncTimeout = null;
    function scheduleLeaderboardSync() {
        if (syncTimeout) clearTimeout(syncTimeout);
        syncTimeout = setTimeout(syncLeaderboardNow, 2000);
    }
    window.scheduleLeaderboardSync = scheduleLeaderboardSync;
    window.syncLeaderboardNow = syncLeaderboardNow; // expose to entire window, guarantees call after Discord login

    const lbRef = ref(db, "leaderboard");
    const lbQuery = query(lbRef, orderByChild("level"), limitToLast(100));
    onValue(lbQuery, snapshot => {
        const val = snapshot.val() || {};
        const players = Object.values(val);
        players.sort((a, b) => {
            const la = a.level || 0, lbv = b.level || 0;
            if (lbv !== la) return lbv - la;
            const fa = a.totalFish || 0, fb = b.totalFish || 0;
            if (fb !== fa) return fb - fa;
            const ba = a.biggestCatchKg || 0, bb = b.biggestCatchKg || 0;
            return bb - ba;
        });
        if (window.setLeaderboardData) window.setLeaderboardData(players);
    });

    // ---------- Global Chat ----------
    const chatRef = ref(db, "chat");

    onValue(chatRef, snapshot => {
        const box = document.getElementById("chatMessages");
        if (!box) return;

        const data = snapshot.val();
        if (!data) {
            box.innerHTML = '<p style="color:#999;text-align:center;">No messages yet...</p>';
            return;
        }

        const keys = Object.keys(data).sort((a, b) => (data[a].time || 0) - (data[b].time || 0));
        let html = "";
        keys.forEach(k => {
            const m = data[k];
            const t = new Date(m.time || 0).toLocaleTimeString();
            html += `
                <div style="margin-bottom:6px;">
                    <strong style="color:#2193b0;">${m.user || "Player"}</strong>
                    <span style="font-size:0.8em;color:#666;">${t}</span><br>
                    <span>${m.text || ""}</span>
                </div>
            `;
        });
        box.innerHTML = html;
        box.scrollTop = box.scrollHeight;
    });

    window.sendChatMessage = function () {
        const input = document.getElementById("chatInput");
        if (!input) return;
        const text = input.value.trim();
        if (!text) return;

        // Always use updated username for chat (in case of Discord login)
        let chatUser = (typeof window.fishingUsername === "string" && window.fishingUsername) || username || "Player";
        if (discordName && discordName.trim()) chatUser = discordName.trim();

        push(chatRef, {
            user: chatUser,
            text: text,
            time: Date.now()
        });

        input.value = "";
    };

    // Also run updateUI to make sure accountName is refreshed to Discord username after login
    if (window.updateUI) window.updateUI();
</script>
</body>
</html>
